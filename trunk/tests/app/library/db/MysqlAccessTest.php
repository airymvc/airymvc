<?php

/**
 * Test class for MysqlAccess.
 * Generated by PHPUnit on 2012-05-02 at 21:48:07.
 */
class MysqlAccessTest extends AiryUnitTest {

    /**
     * @var MysqlAccess
     */
    protected $object;

    /**
     * Sets up the fixture, for example, opens a network connection.
     * This method is called before a test is executed.
     */
    public function testSetUp() {
    	$this->object = new MysqlAccess();
    	$testFilePath = dirname(dirname(dirname(dirname(__FILE__)))) . '/testfiles/test.sql';
		//create test database
		$mysqli = new mysqli("localhost", "root", "root");
		$mysqli->query("CREATE DATABASE airymvc_unit_test");
		$mysqli->select_db("airymvctest");
		$query = file_get_contents($testFilePath);
		$mysqli->multi_query($query);
    }

    /**
     * Tears down the fixture, for example, closes a network connection.
     * This method is called after a test is executed.
     */
    protected function tearDown() {
		$mysqli = new mysqli("localhost", "root", "root");
		$mysqli->query("DROP DATABASE airymvc_unit_test");    	 
    }

    /**
     * 
     * testing the where function
     */
    public function testWhere1() {
    	$condition = array("AND"=>array("="=>array("field1"=>"value1", "field2"=>"value2"), ">"=>array("field3"=>"value3")));
		$result = $this->object->where($condition);
		$compare = " WHERE  `field1` = 'value1' AND `field2` = 'value2' AND `field3` > 'value3' ";
		$this->assertEquals($compare, $result);
    }
    
    public function testWhere2() {		
		$condition = array(""=>array("="=>array("field1" => "value1")));
		$result = $this->object->where($condition);
		$compare = " WHERE  `field1` = 'value1' ";
		$this->assertEquals($compare, $result);
    }


    public function testInnerJoin() {		
		$tables = array("table1", "table2");
		$result = $this->object->innerJoin($tables);		
		$compare = " INNER JOIN `table1` INNER JOIN `table2`";
		$this->assertEquals($compare, $result);
    }
    
    public function testSelect1() {		
		$table = "table1";
		$columns = array ("count(*)", "col1", "col2");
		$result = $this->object->select($columns, $table);		
		$compare = "SELECT count(*), col1, col2 FROM `table1`";
		$this->assertEquals($compare, $result);
    }  

    public function testSelect2() {		
		$table = "table1";
		$columns = array ("count(*)", "col1", "col2");
		$result = $this->object->select($columns, $table, "distinct");		
		$compare = "SELECT DISTINCT count(*), col1, col2 FROM `table1`";
		$this->assertEquals($compare, $result);
    }

    public function testJoinOn1() {	

    	$condition = array ("AND" => array(array( "=", 'table1'=>'field1', 'table2'=>'field2'), 
    									   array("<>", 'table3'=>'field3', 'table2'=>'field2'),
                      					   array("<>", 'table4'=>'field4', 'table3'=>'field3')), 
                			 "OR" => array(array( "=", 'table5'=>'field5', 'table6'=>'field6')));

		$result = $this->object->joinOn($condition);		
		$compare = " ON  `table1`.`field1` = `table2`.`field2` AND `table3`.`field3` <> `table2`.`field2` AND `table4`.`field4` <> `table3`.`field3`  OR `table5`.`field5` = `table6`.`field6` ";
		$this->assertEquals($compare, $result);
    }    
    
    public function testJoinOn2() {	

    	$condition = array ("" => array(array("=", "table1"=>"field1", 
    											   "table2"=>"field2"
    	                                      )
    	                                )
    	                    );

		$result = $this->object->joinOn($condition);		
		$compare = " ON  `table1`.`field1` = `table2`.`field2` ";
		$this->assertEquals($compare, $result);
    } 
    
    public function testGetStatement1() {
    	$columns1 = array(0 => 'attendent.id',
    					  1 => 'attendent.img',
    					  2 => 'attendent.name',
    					  3 => 'award.name',
    					  4 => 'award.annotation',
    					  5 => 'activity_mng.attend_date');
    					  
		$joinTables1 = array(0 => 'activity_mng',
                     		 1 => 'award',);
		
        $condition1 = array("AND" => array(
        								   array("=", 'award'        => 'id',
                   									  'activity_mng' => 'award_id'),
        								   array("=", 'attendent'    => 'id',
                   									  'activity_mng' => 'attendent_id')
        								   )
        				    );

		$this->object->select($columns1, 'attendent');
		$this->object->innerJoin($joinTables1);
		$this->object->joinOn($condition1);

		$where1 = array("AND" => array("=" => array('activity_id' => 5), 
                              		   ">" => array('award_id' => 0)
                           			  )
              			);

		$this->object->where($where1);
		$result = $this->object->getStatement();
		$compare = "SELECT attendent.id, attendent.img, attendent.name, award.name, award.annotation, activity_mng.attend_date FROM `attendent` INNER JOIN `activity_mng` INNER JOIN `award` ON  `award`.`id` = `activity_mng`.`award_id` AND `attendent`.`id` = `activity_mng`.`attendent_id`  WHERE  `activity_id` = '5' AND `award_id` > '0' ";
		$this->assertEquals($compare, $result);
    }
}

?>
